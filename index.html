<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Natya Shastra: The Arangetram Journey (Pro Edition)</title>
    
    <!-- External Libraries (Free/Open Source) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --gold: #D4AF37;
            --gold-shine: #F9E076;
            --deep-red: #5D001E;
            --overlay-bg: rgba(10, 5, 5, 0.92);
        }

        body {
            margin: 0;
            background: #000;
            overflow: hidden;
            font-family: 'Playfair Display', serif;
            color: #fff;
            -webkit-font-smoothing: antialiased;
        }

        /* Loading Overlay */
        #loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 1s;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 3px solid var(--gold);
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Canvas & Stage */
        #game-container {
            position: relative;
            width: 100vw; height: 100vh;
            background: #000;
        }
        canvas { display: block; }

        /* UI Elements */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--overlay-bg);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            z-index: 10;
        }
        .screen.active {
            opacity: 1;
            pointer-events: auto;
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 4rem;
            background: linear-gradient(to bottom, var(--gold-shine), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0 0 20px 0;
            text-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
            text-align: center;
        }

        .panel {
            background: rgba(30, 10, 10, 0.6);
            border: 1px solid var(--gold);
            padding: 40px;
            border-radius: 4px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-width: 600px;
            width: 90%;
            text-align: center;
            border-top: 4px solid var(--gold);
        }

        .btn {
            background: linear-gradient(135deg, var(--deep-red) 0%, #300000 100%);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 15px 40px;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .btn:hover {
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.4);
            transform: translateY(-2px);
            background: linear-gradient(135deg, #700025 0%, #400000 100%);
        }

        /* HUD */
        #hud {
            position: absolute;
            top: 20px; left: 20px; right: 20px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 5;
        }
        .stat-box {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 1.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .combo-text {
            position: absolute;
            left: 50%; top: 20%;
            transform: translateX(-50%);
            font-size: 3rem;
            color: var(--gold-shine);
            opacity: 0;
            font-weight: bold;
            text-shadow: 0 0 20px var(--gold);
        }

        /* Guru Dialog */
        #guru-overlay {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            height: 30vh;
            background: linear-gradient(to top, rgba(0,0,0,1), rgba(0,0,0,0));
            display: flex;
            align-items: flex-end;
            padding-bottom: 30px;
            z-index: 20;
            transform: translateY(120%); /* Hidden by default */
        }
        .guru-container {
            width: 100%; max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
        }
        .guru-portrait {
            width: 150px; height: 150px;
            border-radius: 50%;
            border: 3px solid var(--gold);
            background: #221;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            margin-right: 30px;
            position: relative;
        }
        .guru-text-box {
            flex: 1;
            background: rgba(20, 10, 10, 0.95);
            border: 1px solid var(--gold);
            padding: 25px;
            border-radius: 2px 20px 2px 20px;
            position: relative;
        }
        .guru-name {
            color: var(--gold);
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            letter-spacing: 1px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .guru-message {
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        /* Customization Grid */
        .swatch-grid {
            display: flex; justify-content: center; gap: 15px; margin: 20px 0;
        }
        .swatch {
            width: 40px; height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
            transition: transform 0.2s;
        }
        .swatch.selected {
            border: 3px solid var(--gold);
            transform: scale(1.2);
            box-shadow: 0 0 15px var(--gold);
        }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p style="margin-top:20px; color:var(--gold); font-family:'Cinzel'">Initializing Natya Shastra Engine...</p>
</div>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div id="hud">
        <div class="stat-box" id="score-el">Score: 0</div>
        <div class="stat-box" id="level-el">Introduction</div>
    </div>
    <div id="combo-popup" class="combo-text"></div>

    <!-- MAIN MENU -->
    <div id="screen-menu" class="screen active">
        <div class="panel">
            <h1>Natya Shastra</h1>
            <p>Master the ancient art of Bharatnatyam. Learn the theory, feel the rhythm, and perform your Arangetram.</p>
            
            <div style="margin-top:30px;">
                <p style="color:var(--gold); font-size:0.9rem; text-transform:uppercase;">Select Sari Color</p>
                <div class="swatch-grid" id="sari-swatches">
                    <!-- Injected by JS -->
                </div>
            </div>

            <button class="btn" id="start-btn">Enter the Gurukul</button>
            <p style="font-size:0.8rem; opacity:0.6; margin-top:20px;">Use Arrow Keys to Dance</p>
        </div>
    </div>

    <!-- GURU INTERACTION -->
    <div id="guru-overlay">
        <div class="guru-container">
            <div class="guru-portrait">
                <!-- Procedural Guru Canvas will be drawn here -->
                <canvas id="guruCanvas" width="150" height="150"></canvas>
            </div>
            <div class="guru-text-box">
                <div class="guru-name">Guru Meenakshi</div>
                <div class="guru-message" id="guru-text">Welcome, shishya.</div>
                <div id="quiz-container" style="margin-top:15px; display:none;">
                    <!-- Quiz buttons -->
                </div>
                <div style="text-align:right; margin-top:10px;">
                    <button class="btn" id="dialog-next" style="padding: 5px 20px; font-size: 0.8rem;">Continue</button>
                </div>
            </div>
        </div>
    </div>

    <!-- RESULTS -->
    <div id="screen-result" class="screen">
        <div class="panel">
            <h1 id="result-title">Level Complete</h1>
            <p id="result-desc">Your Abhinaya was exquisite.</p>
            <h2 id="final-score" style="color:var(--gold); font-size:3rem; margin:20px 0;">0</h2>
            <button class="btn" onclick="Game.nextLevel()">Next Assignment</button>
        </div>
    </div>
</div>

<script>
/**
 * PROFESSIONAL BHARATNATYAM GAME ENGINE
 * Uses Tone.js for Generative Audio & GSAP for Animation
 */

// --- 1. CONFIGURATION & STATE ---
const CONSTANTS = {
    COLORS: {
        SARI: ['#D92027', '#FF9F1C', '#2EC4B6', '#5D2E8C'],
        SKIN: ['#8D5524', '#C68642', '#E0AC69', '#F1C27D'],
        BG_GRADIENT: ['#1a0b0b', '#000000']
    },
    KEYS: {
        'ArrowLeft': { x: -150, color: '#FF3D3D' },
        'ArrowDown': { x: -50, color: '#3D8EFF' },
        'ArrowUp':   { x: 50, color: '#3DFF8E' },
        'ArrowRight':{ x: 150, color: '#FFD93D' }
    }
};

const STATE = {
    sariColor: CONSTANTS.COLORS.SARI[0],
    level: 0,
    score: 0,
    combo: 0,
    isPlaying: false,
    inDialog: false
};

// --- 2. AUDIO ENGINE (Tone.js) ---
class AudioEngine {
    constructor() {
        this.initialized = false;
        this.synth = null;
        this.drum = null;
        this.drone = null;
        this.bell = null;
    }

    async init() {
        if (this.initialized) return;
        await Tone.start();
        
        // 1. Mridangam (Drum) - Synthesized membrane
        this.drum = new Tone.MembraneSynth({
            pitchDecay: 0.05,
            octaves: 4,
            oscillator: { type: "sine" },
            envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
        }).toDestination();
        this.drum.volume.value = -5;

        // 2. Veena (Melody) - Plucked string simulation
        this.synth = new Tone.PluckSynth({
            attackNoise: 1,
            dampening: 4000,
            resonance: 0.95
        }).toDestination();
        this.synth.volume.value = -8;

        // 3. Salangai (Ankle Bells) - High frequency FM
        this.bell = new Tone.MetalSynth({
            frequency: 200, envelope: { attack: 0.001, decay: 0.1, release: 0.01 },
            harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5
        }).toDestination();
        this.bell.volume.value = -10;

        // 4. Tanpura (Drone)
        this.drone = new Tone.Oscillator(130.81, "sawtooth4").toDestination();
        this.drone.volume.value = -25; // Quiet background

        this.initialized = true;
    }

    startDrone() {
        if(!this.drone) return;
        this.drone.start();
        // LFO for slight modulation (human feel)
        const lfo = new Tone.LFO(0.1, 129, 132).start();
        lfo.connect(this.drone.frequency);
    }

    playHit() {
        if(!this.bell) return;
        // Randomize slight pitch for realism
        this.bell.triggerAttackRelease(3000 + Math.random()*500, "32n");
    }

    playBeat(time) {
        if(!this.drum) return;
        this.drum.triggerAttackRelease("C2", "8n", time);
    }

    playMelodyNote(note) {
        if(!this.synth) return;
        this.synth.triggerAttack(note, Tone.now());
    }
}

// --- 3. GRAPHICS ENGINE (Canvas) ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const guruCanvas = document.getElementById('guruCanvas');
const gCtx = guruCanvas.getContext('2d');

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

class Dancer {
    constructor() {
        this.y = canvas.height * 0.65;
        this.scale = 0.8;
        this.pose = 'neutral'; 
        this.animVal = 0; // For breathing animation
        this.targetArmL = { x: -40, y: -20 };
        this.targetArmR = { x: 40, y: -20 };
        this.curArmL = { ...this.targetArmL };
        this.curArmR = { ...this.targetArmR };
    }

    update(dt) {
        // Breathing
        this.animVal += dt * 0.002;
        
        // Smooth arm movement (Linear Interpolation)
        const lerp = (start, end, amt) => (1 - amt) * start + amt * end;
        this.curArmL.x = lerp(this.curArmL.x, this.targetArmL.x, 0.2);
        this.curArmL.y = lerp(this.curArmL.y, this.targetArmL.y, 0.2);
        this.curArmR.x = lerp(this.curArmR.x, this.targetArmR.x, 0.2);
        this.curArmR.y = lerp(this.curArmR.y, this.targetArmR.y, 0.2);
    }

    setPose(key) {
        if (key === 'ArrowLeft') { this.targetArmL = {x:-100, y:-60}; this.targetArmR = {x:60, y:-10}; }
        else if (key === 'ArrowRight') { this.targetArmL = {x:-60, y:-10}; this.targetArmR = {x:100, y:-60}; }
        else if (key === 'ArrowUp') { this.targetArmL = {x:-80, y:-90}; this.targetArmR = {x:80, y:-90}; }
        else if (key === 'ArrowDown') { this.targetArmL = {x:-90, y:40}; this.targetArmR = {x:90, y:40}; }
        
        setTimeout(() => {
            this.targetArmL = { x: -40, y: -20 };
            this.targetArmR = { x: 40, y: -20 };
        }, 300);
    }

    draw() {
        const cx = canvas.width / 2;
        const cy = this.y + Math.sin(this.animVal)*5;
        const s = (canvas.height / 900) * this.scale;

        ctx.save();
        ctx.translate(cx, cy);
        ctx.scale(s, s);

        // -- DRAWING PROCEDURAL AVATAR --
        
        // 1. Pleats (Fan)
        ctx.fillStyle = "#FFF";
        ctx.beginPath();
        ctx.moveTo(0, 100);
        ctx.lineTo(-40, 300);
        ctx.quadraticCurveTo(0, 320, 40, 300);
        ctx.fill();

        // 2. Legs (Aramandi Diamond)
        const grd = ctx.createLinearGradient(-50, 0, 50, 300);
        grd.addColorStop(0, STATE.sariColor);
        grd.addColorStop(1, "#220000"); // Shadow
        ctx.fillStyle = grd;
        
        ctx.beginPath();
        ctx.moveTo(0, 100); // Waist
        ctx.lineTo(-70, 240); // Knees out
        ctx.lineTo(-20, 340); // Ankles
        ctx.lineTo(20, 340);
        ctx.lineTo(70, 240);
        ctx.fill();

        // Gold Border on Sari
        ctx.strokeStyle = var2hex("--gold"); 
        ctx.lineWidth = 8;
        ctx.stroke();

        // 3. Torso
        ctx.fillStyle = STATE.sariColor;
        ctx.fillRect(-35, -50, 70, 150);
        // Blouse shading
        ctx.fillStyle = "rgba(0,0,0,0.1)";
        ctx.fillRect(-35, 50, 70, 50);

        // 4. Arms (Dynamic)
        ctx.strokeStyle = "#8D5524"; // Skin
        ctx.lineWidth = 18;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";

        ctx.beginPath();
        ctx.moveTo(-30, -40); // Shoulder L
        ctx.lineTo(this.curArmL.x, this.curArmL.y);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(30, -40); // Shoulder R
        ctx.lineTo(this.curArmR.x, this.curArmR.y);
        ctx.stroke();

        // Bangles
        ctx.strokeStyle = var2hex("--gold");
        ctx.lineWidth = 5;
        ctx.beginPath(); ctx.moveTo(this.curArmL.x, this.curArmL.y); ctx.lineTo(this.curArmL.x+5, this.curArmL.y+5); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(this.curArmR.x, this.curArmR.y); ctx.lineTo(this.curArmR.x-5, this.curArmR.y+5); ctx.stroke();

        // 5. Head & Jewelry
        ctx.fillStyle = "#8D5524";
        ctx.beginPath(); ctx.arc(0, -80, 35, 0, Math.PI*2); ctx.fill(); // Face
        
        // Hair
        ctx.fillStyle = "#111";
        ctx.beginPath(); ctx.arc(0, -90, 38, 0, Math.PI*2); ctx.fill(); 
        
        // Face Details
        ctx.fillStyle = "#400"; // Bindi
        ctx.beginPath(); ctx.arc(0, -85, 4, 0, Math.PI*2); ctx.fill();

        // Crown/Jewelry
        ctx.fillStyle = var2hex("--gold");
        ctx.beginPath(); ctx.moveTo(-35, -90); ctx.quadraticCurveTo(0, -60, 35, -90); ctx.stroke();
        
        ctx.restore();
    }
}

// Helper to get CSS var
function var2hex(v) {
    return getComputedStyle(document.documentElement).getPropertyValue(v).trim();
}

// Procedurally draw Guru Face
function drawGuru() {
    const cx = 75, cy = 75;
    gCtx.fillStyle = "#332211"; // BG
    gCtx.fillRect(0,0,150,150);
    
    // Skin
    gCtx.fillStyle = "#5c3a1e";
    gCtx.beginPath(); gCtx.arc(cx, cy, 50, 0, Math.PI*2); gCtx.fill();
    
    // Hair (Grey bun)
    gCtx.fillStyle = "#666";
    gCtx.beginPath(); gCtx.arc(cx, cy-10, 55, Math.PI, 0); gCtx.fill();
    
    // Big Bindi
    gCtx.fillStyle = "#800000";
    gCtx.beginPath(); gCtx.arc(cx, cy-10, 6, 0, Math.PI*2); gCtx.fill();
}

// --- 4. GAMEPLAY LOGIC ---
const STORIES = [
    {
        title: "Level 1: The Stance (Aramandi)",
        text: "In Bharatnatyam, geometry is divine. We begin with Aramandi - the half-seated posture representing the stabilization of the earth. Keep your back straight.",
        quiz: {
            q: "What shape does the Aramandi stance create with the legs?",
            opts: ["A Square", "A Diamond", "A Circle"],
            ans: 1,
            reply: "Correct. The diamond represents stability."
        },
        bpm: 90,
        notes: 20
    },
    {
        title: "Level 2: The Language of Hands (Mudras)",
        text: "Your hands speak what your voice cannot. The 'Pataka' (Flag) is the beginning. The 'Tripataka' follows. Precision is key.",
        quiz: {
            q: "Which hand gesture (Mudra) denotes a creeper or a bow?",
            opts: ["Pataka", "Kartarimukha", "Shikhara"],
            ans: 1,
            reply: "Yes, Kartarimukha (Scissors face) is used for creepers."
        },
        bpm: 110,
        notes: 40
    },
    {
        title: "Level 3: The Arangetram",
        text: "The stage is set. The musicians are ready. Perform the Thillana with joy and devotion. This is your moment.",
        bpm: 130,
        notes: 60
    }
];

let arrows = [];
let lastSpawn = 0;
const audio = new AudioEngine();
const dancer = new Dancer();

// Initialization
window.onload = () => {
    drawGuru();
    
    // Generate Color Swatches
    const swatchContainer = document.getElementById('sari-swatches');
    CONSTANTS.COLORS.SARI.forEach((c, i) => {
        const div = document.createElement('div');
        div.className = `swatch ${i===0?'selected':''}`;
        div.style.backgroundColor = c;
        div.onclick = () => {
            document.querySelectorAll('.swatch').forEach(e => e.classList.remove('selected'));
            div.classList.add('selected');
            STATE.sariColor = c;
        };
        swatchContainer.appendChild(div);
    });

    document.getElementById('loader').style.opacity = 0;
    setTimeout(() => document.getElementById('loader').remove(), 1000);
    
    // Setup Start
    document.getElementById('start-btn').onclick = async () => {
        await audio.init();
        audio.startDrone();
        document.getElementById('screen-menu').classList.remove('active');
        startLevel(0);
    };
};

function startLevel(lvl) {
    STATE.level = lvl;
    STATE.score = 0;
    STATE.combo = 0;
    document.getElementById('level-el').innerText = STORIES[lvl].title;
    document.getElementById('score-el').innerText = "Score: 0";
    
    // Show Guru
    showDialog(STORIES[lvl]);
}

function showDialog(data) {
    STATE.inDialog = true;
    const overlay = document.getElementById('guru-overlay');
    const txt = document.getElementById('guru-text');
    const quizBox = document.getElementById('quiz-container');
    const nextBtn = document.getElementById('dialog-next');

    // Slide up animation
    gsap.to(overlay, { y: 0, duration: 0.8, ease: "power2.out" });
    
    txt.innerText = data.text;
    quizBox.style.display = 'none';
    nextBtn.style.display = 'inline-block';
    nextBtn.onclick = () => {
        if(data.quiz && !data.quizTaken) {
            // Show Quiz
            data.quizTaken = true; // prevent loop
            txt.innerText = data.quiz.q;
            nextBtn.style.display = 'none';
            quizBox.style.display = 'flex';
            quizBox.innerHTML = '';
            quizBox.style.gap = '10px';
            
            data.quiz.opts.forEach((opt, i) => {
                const b = document.createElement('button');
                b.className = 'btn';
                b.style.fontSize = '0.7rem'; b.style.padding = '10px'; b.style.marginTop = '0';
                b.innerText = opt;
                b.onclick = () => {
                    if(i === data.quiz.ans) {
                        txt.innerText = data.quiz.reply;
                        audio.playMelodyNote("C5"); // Success chime
                        setTimeout(enterGameplay, 2000);
                    } else {
                        txt.innerText = "Focus, shishya. Try again.";
                        audio.playMelodyNote("C3"); // Fail sound
                    }
                };
                quizBox.appendChild(b);
            });
        } else {
            enterGameplay();
        }
    };
}

function enterGameplay() {
    gsap.to('#guru-overlay', { y: "120%", duration: 0.5 });
    STATE.inDialog = false;
    STATE.isPlaying = true;
    
    // Start Music Loop with Tone.js Transport
    const bpm = STORIES[STATE.level].bpm;
    Tone.Transport.bpm.value = bpm;
    
    // Schedule beat
    Tone.Transport.scheduleRepeat((time) => {
        if(!STATE.isPlaying) return;
        audio.playBeat(time);
        spawnArrow();
    }, "4n"); // Quarter note

    Tone.Transport.start();
}

function spawnArrow() {
    const keys = Object.keys(CONSTANTS.KEYS);
    const k = keys[Math.floor(Math.random()*keys.length)];
    const def = CONSTANTS.KEYS[k];
    
    arrows.push({
        key: k, x: (canvas.width/2) + def.x, y: -50, 
        color: def.color, active: true
    });
}

// Input Handling
window.addEventListener('keydown', (e) => {
    if(!STATE.isPlaying) return;
    if(CONSTANTS.KEYS[e.code]) {
        dancer.setPose(e.code);
        
        // Hit detection
        const targetY = canvas.height - 100;
        const hit = arrows.find(a => a.active && a.key === e.code && Math.abs(a.y - targetY) < 80);
        
        if(hit) {
            hit.active = false;
            STATE.score += 100 + (STATE.combo * 10);
            STATE.combo++;
            audio.playHit();
            
            // Visual Popup
            const pop = document.getElementById('combo-popup');
            pop.innerText = ["Good!", "Perfect!", "Divine!"][Math.min(2, Math.floor(STATE.combo/5))];
            gsap.fromTo(pop, {opacity:1, scale:0.5}, {opacity:0, scale:1.5, duration:0.5});
            
            document.getElementById('score-el').innerText = "Score: " + STATE.score;
        } else {
            STATE.combo = 0;
        }
    }
});

// Game Loop
const Game = {
    nextLevel: function() {
        document.getElementById('screen-result').classList.remove('active');
        if(STATE.level + 1 < STORIES.length) {
            startLevel(STATE.level + 1);
        } else {
            alert("Arangetram Complete! You are now a master.");
            location.reload();
        }
    }
};

function loop(time) {
    // 1. Clear & Background
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0, canvas.width, canvas.height);
    
    // Dynamic Spotlight Background
    const spotX = canvas.width/2 + Math.sin(time/1000)*50;
    const grd = ctx.createRadialGradient(spotX, canvas.height/2, 50, canvas.width/2, canvas.height/2, 800);
    grd.addColorStop(0, "#2a1515");
    grd.addColorStop(1, "#000");
    ctx.fillStyle = grd;
    ctx.fillRect(0,0, canvas.width, canvas.height);

    // Floor
    ctx.fillStyle = "#1a1111";
    ctx.beginPath(); ctx.ellipse(canvas.width/2, canvas.height, canvas.width/1.2, 150, 0, 0, Math.PI*2); ctx.fill();

    if(!STATE.inDialog) {
        dancer.update(16); // assume 60fps delta roughly
        dancer.draw();
    }

    if(STATE.isPlaying) {
        // Draw HUD Lines
        const ty = canvas.height - 100;
        ctx.strokeStyle = "rgba(212, 175, 55, 0.3)";
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(0, ty); ctx.lineTo(canvas.width, ty); ctx.stroke();

        // Draw Arrows
        arrows.forEach(a => {
            if(!a.active) return;
            a.y += 6; // Speed
            
            ctx.shadowBlur = 10;
            ctx.shadowColor = a.color;
            ctx.fillStyle = a.color;
            
            // Draw stylized arrow
            ctx.beginPath();
            ctx.arc(a.x, a.y, 20, 0, Math.PI*2);
            ctx.fill();
            ctx.shadowBlur = 0;
        });

        // Cleanup
        arrows = arrows.filter(a => a.y < canvas.height + 50 && a.active);

        // Win Condition
        if(STATE.score > STORIES[STATE.level].notes * 80) {
            STATE.isPlaying = false;
            Tone.Transport.stop();
            document.getElementById('screen-result').classList.add('active');
            document.getElementById('final-score').innerText = STATE.score;
            arrows = [];
        }
    }

    requestAnimationFrame(loop);
}

requestAnimationFrame(loop);

</script>
</body>
</html>
